---
title: "Stat 184 Final Project"
author: "Kelly Zhang, Tyler Wong, Yuheng Xie"
date: "`r paste('Last Updated:', Sys.Date())`"
output:
  html_notebook: default
  pdf_document: default
  html_document:
    df_print: paged
---

## Introduction

**Are Used Car Prices Different in Inner and Outer Cities?**

Since 2020, notably after the pandemic, car prices have soared to new heights. In accordance to economic inflation, specifically fuel prices, there is no doubt that purchasing a new car requires immense reflection and a strong financial position. One solution to consider is to purchase a used car. 

When it comes to purchasing a used car, many factors are considered. Such factors include price of the car, the mileage, and the model. These elements have proved to be statistically significant in determining the price of a used car; however, what about the location from whom the car is purchased? 
For instance, the supply and demand in inner cities, such as New York or Philadelphia, may be higher than that of rural or suburban areas like Harrisburg or Albany. Because inner cities have a larger population, demand may be higher, and this can lead to car price inflation. On the other hand, less populated areas may have less demand and could be cheaper. Therefore, a research question could be, "Are Used Car Prices Different in Inner and Outer Cities?"

To answer the question, our group used data from Autotrader. The Autotrader dataset generator is a website that generates CSV datasets of used cars listed at autotrader.com, which is an online auto retailer, based on a maker, a model, and a zip code. In the data set, each case represents an individual Ford car. We chose Ford as the focused model as it is the most popular car brand in the United States. This would allow for large amounts of data. We randomly selected one major city and a suburban or rural area. These locations are New York City and Albany, and Philadelphia and Harrisburg. In the dataset, there are the variables year, price, and mileage; thus, we will need to add a column for "location." This is further explained in the data visualization preparation process.

## Data Visualization Preparation

**Data Visualization Preparation Process**

The research conducted is split into 4 parts. The first part is data wrangling and data preparation. The data set is tidied, but the data is separated by model. Because we are focused on price and location, we add a location column and merge every Ford model to create a New York City data set. This procedure is then repeated for the following cities: Albany, Philadelphia, and Harrisburg. There are 4 data sets representing location and price. Additionally, each dataset is filtered to remove all N/A values and prices that are 0, as prices cannot be $0. 

**Load Packages**

```{r, include = F}
rm(list = ls()) #clear the workspace

library(knitr)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(ggformula)
library(mosaic)
library(car)
library(janitor)
library(kableExtra)
library(psych)
library(tidyr)
library(tidyverse)
```

**Import Datasets**

```{r, include = F}
NYC_Taurus <- read.csv("NY (Taurus).csv")
NYC_Mustang <- read.csv("NY (Mustang).csv")
NYC_Fusion <- read.csv("NY (Fusion).csv")
NYC_Focus <- read.csv("NY (Focus).csv")
NYC_Fiesta <- read.csv("NY (Fiesta).csv")
NYC_F350 <- read.csv("NY (F350).csv")
NYC_F250 <- read.csv("NY (F250).csv")
NYC_F150 <- read.csv("NY (F150).csv")
NYC_Explorer <- read.csv("NY (Explorer).csv")
NYC_Escape <- read.csv("NY (Escape).csv")
NYC_Edge <- read.csv("NY (Edge).csv")

ALB_Taurus <- read.csv("ALB_Taurus.csv")
ALB_Mustang <- read.csv("ALB_Mustang.csv")
ALB_Fusion <- read.csv("ALB_Fusion.csv")
ALB_Focus <- read.csv("ALB_Focus.csv")
ALB_Fiesta <- read.csv("ALB_Fiesta.csv")
ALB_F350 <- read.csv("ALB_F350.csv")
ALB_F250 <- read.csv("ALB_F250.csv")
ALB_F150 <- read.csv("ALB_F150.csv")
ALB_Explorer <- read.csv("ALB_Explorer.csv")
ALB_Escape <- read.csv("ALB_Escape.csv")
ALB_Edge <- read.csv("ALB_Edge.csv")

PHIL_Taurus <- read.csv("PHIL_Taurus.csv")
PHIL_Mustang <- read.csv("PHIL_Mustang.csv")
PHIL_Fusion <- read.csv("PHIL_Fusion.csv")
PHIL_Focus <- read.csv("PHIL_Focus.csv")
PHIL_Fiesta <- read.csv("PHIL_Fiesta.csv")
PHIL_F350 <- read.csv("PHIL_F350.csv")
PHIL_F250 <- read.csv("PHIL_F250.csv")
PHIL_F150 <- read.csv("PHIL_F150.csv")
PHIL_Explorer <- read.csv("PHIL_Explorer.csv")
PHIL_Escape <- read.csv("PHIL_Escape.csv")
PHIL_Edge <- read.csv("PHIL_Edge.csv")

HARS_Taurus <- read.csv("HARS_Taurus.csv")
HARS_Mustang <- read.csv("HARS_Mustang.csv")
HARS_Fusion <- read.csv("HARS_Fusion.csv")
HARS_Focus <- read.csv("HARS_Focus.csv")
HARS_Fiesta <- read.csv("HARS_Fiesta.csv")
HARS_F350 <- read.csv("HARS_F350.csv")
HARS_F250 <- read.csv("HARS_F250.csv")
HARS_F150 <- read.csv("HARS_F150.csv")
HARS_Explorer <- read.csv("HARS_Explorer.csv")
HARS_Escape <- read.csv("HARS_Escape.csv")
HARS_Edge <- read.csv("HARS_Edge.csv")

```

**Add Location Column and Merge Datasets**

```{r}

NYC = rbind(NYC_Taurus, NYC_Mustang, NYC_Fusion, NYC_Focus, NYC_Fiesta, NYC_F350, NYC_F250, NYC_F150, NYC_Explorer, NYC_Escape, NYC_Edge) %>%
  select(-mileage) %>%
  filter(price != 0)

NYC$Location = rep("New York City", nrow(NYC))

ALB = rbind(ALB_Taurus, ALB_Mustang, ALB_Fusion, ALB_Focus, ALB_Fiesta, ALB_F350, ALB_F250, ALB_F150, ALB_Explorer, ALB_Escape, ALB_Edge) %>%
  select(-mileage) %>%
  filter(price != 0)

ALB$Location = rep("Albany", nrow(ALB))

PHIL = rbind(PHIL_Taurus, PHIL_Mustang, PHIL_Fusion, PHIL_Focus, PHIL_Fiesta, PHIL_F350, PHIL_F250, PHIL_F150, PHIL_Explorer, PHIL_Escape, PHIL_Edge) %>%
  select(-mileage) %>%
  filter(price != 0)

PHIL$Location = rep("Philadelphia", nrow(PHIL))

HARS = rbind(HARS_Taurus, HARS_Mustang, HARS_Fusion, HARS_Focus, HARS_Fiesta, HARS_F350, HARS_F250, HARS_F150, HARS_Explorer, HARS_Escape, HARS_Edge) %>%
  select(-mileage) %>%
  filter(price != 0)

HARS$Location = rep("Harrisburg", nrow(HARS))

NY <- bind_rows(NYC, ALB) %>%
  na.omit()

PA <- bind_rows(HARS, PHIL) %>%
  na.omit()

All_Cars <- bind_rows(ALB, PHIL, NYC, HARS) %>%
  na.omit() 

write.csv(All_Cars, file = "All_Cars.csv") #add merged dataset to gitHUB

```

## Data Exploration and Visaulization

**Data Inspection**
```{r}
head(All_Cars)

glimpse(All_Cars)
```

Based on the data inspection, all elements are structured correctly. For year and price, the variables are measured quantitatively, with integer and floats (accepting decimal values). Regarding location, the cases are categorical and represented by characters or strings. Thus, when doing EDA, we can expect the data frame to provide an output for price, in decimals, and location, as strings. This will be important as we are able to create certain graphs, like boxplots, that account for one quantitative and one categorical variable.

**Side-by-Side Boxplot**

For the data exploration and visualization process, we create a box plot as there is categorical and quantitative data. A box plot is a strong data visualization to portray the relationship between these variables, and the visualization of a five-number summary. 

***Five-number summary***: descriptive statistics that output a minimum value, first-quartile (25% or 25th percentile), median (50% or 50th percentile), third quartile (75% or 75th percentile), and the maximum value. 

##### Boxplot 1: New York

```{r}
ggplot(
data = NY,
mapping = aes(x = Location, y = price, fill = Location)) +
  geom_boxplot() +
  ggtitle("Boxplot of Used Ford Car Prices in New York") +
  scale_fill_manual(values = c("salmon", "salmon1")) +
  theme_bw() +
  xlab("Location") +
  ylab("Price (in USD)") +
  theme(
  legend.position = "none",
  text = element_text(size = 12))
```

##### Boxplot 2: Pennsylvania

```{r}
ggplot(
data = PA,
mapping = aes(x = Location, y = price, fill = Location)) +
  geom_boxplot() +
  ggtitle("Boxplot of Used Ford Car Prices in Pennsylvania") +
  theme_bw() +
  xlab("Location") +
  ylab("Price (in USD)") +
  scale_fill_manual(values = c("lightblue", "lightblue4")) +
  theme(
  legend.position = "none",
  text = element_text(size = 12))
```

**Boxplot Observations:**

From the boxplot 1 and 2, New York and Pennsylvania, there are multiple observations that can be insightful. Firstly, notice the amount of outliers. These outliers are difficult to remove due to the different confounding variables regarding price variation. Although we were able to remove few outliers with cars that were $0, higher outliers are not as easily found. The second observation is the actual IQR values. The IQR range (third quartile - first quartile) and median are similar in both locations, suggesting that there may not be a statistically significant difference. 

### **Bar Graphs**

##### Bar Graph 1: New York

```{r}

NY_Median <- NY %>%
  group_by(Location) %>%
  summarise(median_price = median(price), na.rm = TRUE)

ggplot(
data = NY_Median,
mapping = aes(x = Location, y = median_price, fill = Location)) +
  scale_fill_manual(values = c("salmon", "salmon1")) +
  geom_bar(stat = "identity", width = 0.3) +
  ggtitle("Bargraph of Used Ford Car Prices by Location") +
  theme_bw() +
  xlab("Location") +
  ylab("Median Price (USD)") +
  theme(
  legend.position = "none",
  text = element_text(size = 10))

```

##### Bar Graph 2: Pennsylvania

```{r}
PA_Median <- PA %>%
  group_by(Location) %>%
  summarise(median_price = median(price), na.rm = TRUE)

ggplot(
data = PA_Median,
mapping = aes(x = Location, y = median_price, fill = Location)) +
  scale_fill_manual(values = c("lightblue", "lightblue4")) +
  geom_bar(stat = "identity", width = 0.3) +
  ggtitle("Bargraph of Used Ford Car Prices by Location") +
  theme_bw() +
  xlab("Location") +
  ylab("Median Price (USD)") +
  theme(
  legend.position = "none",
  text = element_text(size = 10))

```
**Bar Graph Observations:**

From the side-to-side boxplot, we concluded that there is a minor difference between the inner and outer city car prices. The bar graphs allow us to "zoom in" on this visualization by wrangling both data sets with group_by() and summarise() function. Using these functions, we can calculate the median for both data sets. Typically, the mean is used for discussing averages; however, as found in the boxplots, there are many outliers, which are difficult to remove. Thus, we are able to use median to minimize the effects of outliers and influential points in the data. As observed in both plots, the median prices are not significantly different between locations. In fact, there may only be a noticeable thousand dollar distinction. 

### **Scatterplot Graphs**

##### Scatterplot Graph 1: New York

**Scatterplot Process & Purpose:**

The scatterplot is a model that is different from our general data visualization process. One of the main differences is the x-axis includes the variable "year," meaning there are 3 variables of interest (price, year, location), rather than the original two variables, price and location. The reason a scatterplot was introduced was to display the overall trend of Ford cars to support the two regression lines. Without each individual data point, we may not understand where the inserction between lines occur or why it is a positive slope.

```{r}

gf_point(price ~ year, color = ~ Location, data = NY) %>%
  gf_lm()

```

**Scatterplot 1 Observations**

In the first scatterplot, there are multiple observations to note. Firstly, notice that there is an intersection point between the lines. This is interesting as it provides evidence that there may be a significant interaction term between location and price. We can later test this theory by using a hypothesis test and fitted model. 

Secondly, the heavy increasing trend towards the year 2020. Almost in the shape of a helix, the values on the far right introduce an all-time-high price at around $150 000. Given that this may be an outlier, when observing the data that follows, there is no doubt that as the year increases, so does the price. In the context of the data set, this provides evidence that the newer the car, the higher the price. Although this does not necessarily support our location and price research inquiry, it is important to explore other variables when location and price seem to be insignificant. 


##### Scatterplot Graph 2: Pennsylvania

```{r}

gf_point(price ~ year, color = ~ Location, data = PA) %>%
  gf_lm()
```

**Scatterplot 2 Observations:**

The second scatterplot, between Harrisburg and Philadephia, is notable because the lines are extremely similar. This is contradicting information from the first scatterplot, in which there were small differences in slope and y-intercept, specifically between the 1990 to 2010. This provided evidence that there may be a difference in locations and price. However, from the Pennsylvania scatterplot, the plot shows little evidence that there is a relevant difference in prices for Harrisburg and Philadephia. 


### **Summary Table**

##### Summary Table 1: New York

```{r}
# Get descriptive statistics of price and location
groupStats_NY <- psych::describeBy(
  x = NY$price,
  group = NY$Location,
  na.rm = TRUE,
  skew = TRUE,
  ranges = TRUE,
  quant = c(0.25, 0.75),
  IQR = TRUE,
  mat = TRUE,
  digits = 4)

# Set row names as location; select useful columns
groupStats_NY <- groupStats_NY %>%
  tibble::remove_rownames() %>%
  tibble::column_to_rownames(
  var = "group1") %>%
  dplyr::select(
  n, min, Q0.25, median, Q0.75, max, mad, mean, sd, skew, kurtosis)

# Generate a professional looking table
groupStats_NY %>%
  knitr::kable(
    caption = "Summary Statistics for Used Car Prices (in Thousands) in New York",
    digits = 3,
    format.args = list(big.mark = ","),
    align = rep('c', 11),
    col.names = c("n", "Min", "Q1", "Median", "Q3", "Max", "MAD", "SAM", "SASD",
    "Sample Skew", "Sample Ex. Kurtosis"),
  booktabs = TRUE) %>%
  kableExtra::kable_styling(
  font_size = 12,
  latex_options = c("scale_down", "HOLD_position"))

```

**Summary Table 1 Observations:**


In the summary table, we are provided with multiple outputs, a five-number summary and informaton about the error. The **sample minimum** and **sample maximum** informs us about the lowest prices of each location. In the state of New York, the lowest prices for a used Ford is 1000 dollars USD in both the outer and inner city, and the highest price is approximately 130 thousand dollars in the outer city and 150 thousand dollars in the inner city. While this does not provide useful evidence towards our research question, it is informative in determining possible outliers within the minimum and maximum values.

The first quartile (Q1), or 25% of the data, lies within 20 thousand dollars, respectfully for both Albany and New York City, with a difference of 3000 dollars. The third quartile (Q3), or 75% of the data, are less than 38 thousand dollars and 37.45 thousand dollars. This is the higher end of the prices, but in comparison to the first quartile, the price differences are similar, with a simple 0.546 thousand distinction. In terms of MAD, SAM, SASD, and Sample Skew, these are useful in determining the overall distribution and error rate of the data. Notice, the standard deviation is quite high. This may be an issue, however, when accounting for the minimum and maximum values, ranging from 16 thousand dollars to 150 thousand dollars, a standard deviation of 15 to 16 thousand is understandable. 

The most significant aspect of the summary table is median. Because we are interested in determining an overall trend, the average (or median), can be useful in determining whether or not there is a significant difference in the car prices of all models. In New York, the median prices for inner and outer city are quite similar, with a 2.695 thousand dollar margin, while accounting for the range of values; however, to most, 2.695 thousand dollars would likely be a significant difference. 


##### Summary Table 2: Pennsylvania

```{r}
groupStats_PA <- psych::describeBy(
  x = PA$price,
  group = PA$Location,
  na.rm = TRUE,
  skew = TRUE,
  ranges = TRUE,
  quant = c(0.25, 0.75),
  IQR = TRUE,
  mat = TRUE,
  digits = 4)

# Set row names as location; select useful columns
groupStats_PA <- groupStats_PA %>%
  tibble::remove_rownames() %>%
  tibble::column_to_rownames(
  var = "group1") %>%
  dplyr::select(
  n, min, Q0.25, median, Q0.75, max, mad, mean, sd, skew, kurtosis)

# Generate a professional looking table
groupStats_PA %>%
  knitr::kable(
    caption = "Summary Statistics for Used Car Prices (in Thousands) in Pennsylvania",
    digits = 3,
    format.args = list(big.mark = ","),
    align = rep('c', 11),
    col.names = c("n", "Min", "Q1", "Median", "Q3", "Max", "MAD", "SAM", "SASD",
    "Sample Skew", "Sample Ex. Kurtosis"),
  booktabs = TRUE) %>%
  kableExtra::kable_styling(
  font_size = 12,
  latex_options = c("scale_down", "HOLD_position"))

```

**Summary Table 2 Observations**

In table 2, the minimum values are 2 thousand dollars and 1.795 thousand dollars. Interestingly, this is higher than the comparison in New York. While this does not satisfy our research question, it could provide insight towards prices differing based on state. Interestingly, the maximum value are the same in both areas, 148 thousand dollars. Because the average is around 25 thousand dollars, it is likely that, similar to the New York maximum, this data point could be a potential outlier. Thus, the maximum and minimum values are not entirely reliable for our research question.

Regarding the first quartile, Q1, 25% of the recorded prices are below 17 thousand dollars, respectively. There is a slim difference of 0.703 thousand dollars. The third quartile prices, Q3, are less than 37.9 thousand dollars and 36.988 thousand dollars. Again, the difference is not significant enough to state that there is significance in price based on location. From the summary table of Pennsylvania, the prices are higher as whole, but when compared to the summary of New York, there is less of a location difference. This is mildly contradicting to our research question; however, it is insight to consider other confounding variables that may arise from the data set, such as year of the model.

The median of the locations, 25.769 and 24.995 thousand dollars further highlight the average price of a Used Ford car to be around mid 20 thousand dollars, whether or not it is in the inner or outer city, when using evidence from both Pennsylvania and New York. There does not seem to be a significant difference in the median values, and based on the full analysis of the table, including the five-number summary and maximum and minimum, Pennsylvania does not have any important distinction in where consumers should purchase used Fords. 

